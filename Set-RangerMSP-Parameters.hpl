<?xml version="1.0" encoding="UTF-8"?>
<pipeline>
  <info>
    <name>Set-RangerMSP-Parameters</name>
    <name_sync_with_filename>Y</name_sync_with_filename>
    <description/>
    <extended_description/>
    <pipeline_version/>
    <pipeline_type>Normal</pipeline_type>
    <pipeline_status>0</pipeline_status>
    <parameters>
    </parameters>
    <capture_transform_performance>N</capture_transform_performance>
    <transform_performance_capturing_delay>1000</transform_performance_capturing_delay>
    <transform_performance_capturing_size_limit>100</transform_performance_capturing_size_limit>
    <created_user>-</created_user>
    <created_date>2020/01/03 22:40:31.737</created_date>
    <modified_user>admin</modified_user>
    <modified_date>2020/01/05 12:32:41.443</modified_date>
    <key_for_session_key>H4sIAAAAAAAAAAMAAAAAAAAAAAA=</key_for_session_key>
    <is_key_private>N</is_key_private>
  </info>
  <notepads>
  </notepads>
  <order>
    <hop>
      <from>Get variables</from>
      <to>Filter rows</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Generate rows</from>
      <to>Get variables</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Filter rows</from>
      <to>Get all companies query</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Filter rows</from>
      <to>Get activecompanies query</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Get variables</from>
      <to>Set ingestion parameters (limits)</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Ingest inactiveassets</from>
      <to>Get active assets query</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Ingest inactiveassets</from>
      <to>Get all assets query</to>
      <enabled>Y</enabled>
    </hop>
    <hop>
      <from>Get variables</from>
      <to>Ingest inactiveassets</to>
      <enabled>Y</enabled>
    </hop>
  </order>
  <transform>
    <name>Filter rows</name>
    <type>FilterRows</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <send_true_to>Get all companies query</send_true_to>
    <send_false_to>Get activecompanies query</send_false_to>
    <compare>
      <condition>
        <negated>N</negated>
        <leftvalue>inactivecompanies</leftvalue>
        <function>=</function>
        <rightvalue/>
        <value>
          <name>constant</name>
          <type>Boolean</type>
          <text>Y</text>
          <length>-1</length>
          <precision>-1</precision>
          <isnull>N</isnull>
          <mask/>
        </value>
      </condition>
    </compare>
    <attributes/>
    <GUI>
      <xloc>656</xloc>
      <yloc>128</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Generate rows</name>
    <type>RowGenerator</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <length>-1</length>
        <name>allcompanies</name>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
        <type>String</type>
        <nullif>SELECT recid,accountstatus,bcrecid,city,kind,cardid3,company,createdate,updatedate,assigncardid from cards WHERE company is NOT NULL AND kind is NOT NULL AND entitykind=1 AND (CREATEDATE > ? ) ORDER BY createdate ASC</nullif>
      </field>
      <field>
        <length>-1</length>
        <name>activecompanies</name>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
        <type>String</type>
        <nullif>SELECT recid,accountstatus,bcrecid,city,kind,cardid3,company,createdate,updatedate,assigncardid from cards WHERE company is NOT NULL AND kind is NOT NULL AND entitykind=1 AND (CREATEDATE > ? ) AND accountstatus = 'A' ORDER BY createdate ASC</nullif>
      </field>
      <field>
        <length>-1</length>
        <name>allassets</name>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
        <type>String</type>
      </field>
      <field>
        <length>-1</length>
        <name>activeassets</name>
        <precision>-1</precision>
        <set_empty_string>N</set_empty_string>
        <type>String</type>
        <nullif> and a.STATUS='A' </nullif>
      </field>
    </fields>
    <interval_in_ms>5000</interval_in_ms>
    <last_time_field>FiveSecondsAgo</last_time_field>
    <never_ending>N</never_ending>
    <limit>1</limit>
    <row_time_field>now</row_time_field>
    <attributes/>
    <GUI>
      <xloc>128</xloc>
      <yloc>128</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Get active assets query</name>
    <type>SetVariable</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <field_name>activeassets</field_name>
        <variable_name>newassetrangerquery</variable_name>
        <variable_type>ROOT_WORKFLOW</variable_type>
        <default_value/>
      </field>
    </fields>
    <use_formatting>Y</use_formatting>
    <attributes/>
    <GUI>
      <xloc>832</xloc>
      <yloc>480</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Get activecompanies query</name>
    <type>SetVariable</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <field_name>activecompanies</field_name>
        <variable_name>newcompanyrangerquery</variable_name>
        <variable_type>ROOT_WORKFLOW</variable_type>
        <default_value/>
      </field>
    </fields>
    <use_formatting>Y</use_formatting>
    <attributes/>
    <GUI>
      <xloc>816</xloc>
      <yloc>208</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Get all assets query</name>
    <type>SetVariable</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <field_name>allassets</field_name>
        <variable_name>newassetrangerquery</variable_name>
        <variable_type>ROOT_WORKFLOW</variable_type>
        <default_value/>
      </field>
    </fields>
    <use_formatting>Y</use_formatting>
    <attributes/>
    <GUI>
      <xloc>816</xloc>
      <yloc>304</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Get all companies query</name>
    <type>SetVariable</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <field_name>allcompanies</field_name>
        <variable_name>newcompanyrangerquery</variable_name>
        <variable_type>ROOT_WORKFLOW</variable_type>
        <default_value/>
      </field>
    </fields>
    <use_formatting>Y</use_formatting>
    <attributes/>
    <GUI>
      <xloc>816</xloc>
      <yloc>80</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Get variables</name>
    <type>GetVariable</type>
    <description/>
    <distribute>N</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <fields>
      <field>
        <name>daysoftickets</name>
        <variable>${daysoftickets}</variable>
        <type>Integer</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>daysofcharges</name>
        <variable>${daysofcharges}</variable>
        <type>Integer</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>daysofcontracts</name>
        <variable>${daysofcontracts}</variable>
        <type>Integer</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>daysofopportunities</name>
        <variable>${daysofopportunities}</variable>
        <type>Integer</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>daysofhistory</name>
        <variable>${daysofhistory}</variable>
        <type>Integer</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>agetopurgeticketcharges</name>
        <variable>${agetopurgeticketcharges}</variable>
        <type>Integer</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>inactivecompanies</name>
        <variable>${inactivecompanies}</variable>
        <type>Boolean</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>inactiveassets</name>
        <variable>${inactiveassets}</variable>
        <type>Boolean</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>inactivecontacts</name>
        <variable>${inactivecontacts}</variable>
        <type>Boolean</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
      <field>
        <name>inactivecontracts</name>
        <variable>${inactivecontracts}</variable>
        <type>Boolean</type>
        <format/>
        <currency/>
        <decimal/>
        <group/>
        <length>-1</length>
        <precision>-1</precision>
        <trim_type>none</trim_type>
      </field>
    </fields>
    <attributes/>
    <GUI>
      <xloc>272</xloc>
      <yloc>128</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Ingest inactiveassets</name>
    <type>FilterRows</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <send_true_to>Get all assets query</send_true_to>
    <send_false_to>Get active assets query</send_false_to>
    <compare>
      <condition>
        <negated>N</negated>
        <leftvalue>inactiveassets</leftvalue>
        <function>=</function>
        <rightvalue/>
        <value>
          <name>constant</name>
          <type>Boolean</type>
          <text>Y</text>
          <length>-1</length>
          <precision>-1</precision>
          <isnull>N</isnull>
          <mask/>
        </value>
      </condition>
    </compare>
    <attributes/>
    <GUI>
      <xloc>656</xloc>
      <yloc>352</yloc>
    </GUI>
  </transform>
  <transform>
    <name>Set ingestion parameters (limits)</name>
    <type>Neo4jCypherOutput</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <connection>${graphdb-ds}</connection>
    <cypher>MATCH (cdl:Rangerdataload {name:'RangerMSP'})
WITH cdl,toInteger($params[0].daysoftickets)*-1 as ticketdays,
toInteger($params[0].daysofcharges)*-1 as chargedays,
toInteger($params[0].daysofopportunities)*-1 as oppsdays,
toInteger($params[0].daysofcontracts)*-1 as contractdays,
toInteger($params[0].daysofhistory)*-1 as historydays,
toInteger($params[0].agetopurgeticketcharges)*-1 as ticketchargedays
SET cdl.ticketlimiter = apoc.date.add(timestamp(),'ms',ticketdays, 'd'),
cdl.chargelimiter=apoc.date.add(timestamp(),'ms',chargedays, 'd'),
cdl.opplimiter=apoc.date.add(timestamp(),'ms',oppsdays, 'd'),
cdl.contractlimiter=apoc.date.add(timestamp(),'ms',contractdays, 'd'),
cdl.historylimiter=apoc.date.add(timestamp(),'ms',historydays, 'd'),
cdl.ticketchargelimiter=apoc.date.add(timestamp(),'ms',ticketchargedays, 'd')

</cypher>
    <batch_size/>
    <read_only>N</read_only>
    <nr_retries_on_error/>
    <retry>Y</retry>
    <cypher_from_field>N</cypher_from_field>
    <cypher_field/>
    <unwind>Y</unwind>
    <unwind_map>params</unwind_map>
    <returning_graph>N</returning_graph>
    <return_graph_field/>
    <mappings>
      <mapping>
        <parameter>daysoftickets</parameter>
        <field>daysoftickets</field>
        <type>Integer</type>
      </mapping>
      <mapping>
        <parameter>allcompanies</parameter>
        <field>allcompanies</field>
        <type>String</type>
      </mapping>
      <mapping>
        <parameter>activecompanies</parameter>
        <field>activecompanies</field>
        <type>String</type>
      </mapping>
      <mapping>
        <parameter>inactivecompanies</parameter>
        <field>inactivecompanies</field>
        <type>Boolean</type>
      </mapping>
      <mapping>
        <parameter>daysofcharges</parameter>
        <field>daysofcharges</field>
        <type>Integer</type>
      </mapping>
      <mapping>
        <parameter>daysofcontracts</parameter>
        <field>daysofcontracts</field>
        <type>Integer</type>
      </mapping>
      <mapping>
        <parameter>daysofopportunities</parameter>
        <field>daysofopportunities</field>
        <type>Integer</type>
      </mapping>
      <mapping>
        <parameter>daysofhistory</parameter>
        <field>daysofhistory</field>
        <type>Integer</type>
      </mapping>
      <mapping>
        <parameter>agetopurgeticketcharges</parameter>
        <field>agetopurgeticketcharges</field>
        <type>Integer</type>
      </mapping>
    </mappings>
    <returns/>
    <attributes/>
    <GUI>
      <xloc>272</xloc>
      <yloc>256</yloc>
    </GUI>
  </transform>
  <transform_error_handling>
  </transform_error_handling>
  <attributes/>
</pipeline>
